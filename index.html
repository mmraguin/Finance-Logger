<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>YNAB</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Syne:wght@700&family=Space+Grotesk:wght@400;500;600;700&family=DM+Mono:wght@400;500&family=DM+Sans:wght@300;400;500;600&display=swap');

:root {
  --bg: #0b0b0d;
  --surface: #141416;
  --surface2: #1e1e22;
  --surface3: #28282e;
  --border: #2a2a30;
  --border2: #363640;
  --accent: #2a9d9f;
  --accent-dim: rgba(42,157,159,0.1);
  --accent-border: rgba(42,157,159,0.3);
  --text: #ededf0;
  --text2: #9898a6;
  --muted: #60606e;
  --danger: #ff5c5c;
  --danger-dim: rgba(255,92,92,0.08);
  --danger-border: rgba(255,92,92,0.25);
  --income: #4ade80;
  --expense: #ff5c5c;
  --transfer: #b8a9e0;
  --transfer-dim: rgba(184,169,224,0.08);
  --warn: #c8922a;
  --warn-dim: rgba(200,146,42,0.08);
  --warn-border: rgba(200,146,42,0.25);
}

* { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
html, body { height: 100%; }
body { font-family: 'DM Sans', sans-serif; background: var(--bg); color: var(--text); display: flex; justify-content: center; overflow-x: hidden; }

.app { width: 100%; max-width: 430px; min-height: 100%; display: flex; flex-direction: column; padding-bottom: 40px; }

/* â”€â”€ TOP BAR â”€â”€ */
.topbar { padding: 20px 20px 0; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
.wordmark { font-family: 'Syne', sans-serif; font-size: 18px; font-weight: 700; color: var(--text); letter-spacing: -0.02em; }
.wordmark span { color: var(--accent); }
.gear-btn { width: 36px; height: 36px; border-radius: 10px; border: 1px solid var(--border); background: var(--surface); color: var(--muted); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.15s; font-size: 16px; }
.gear-btn:hover { border-color: var(--border2); color: var(--text2); }
.gear-btn:active { transform: scale(0.92); }

/* â”€â”€ MODE PILLS â”€â”€ */
.mode-strip { padding: 16px 20px 0; flex-shrink: 0; }
.pills { display: flex; background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 3px; gap: 2px; }
.pill { flex: 1; padding: 8px 4px; border-radius: 9px; font-size: 12px; font-weight: 500; color: var(--muted); text-align: center; cursor: pointer; transition: all 0.18s; white-space: nowrap; user-select: none; }
.pill:hover { color: var(--text2); }
.pill.active { background: var(--surface3); color: var(--text); font-weight: 600; }
.pill.active[data-mode="expense"] { color: var(--expense); }
.pill.active[data-mode="income"]  { color: var(--income); }
.pill.active[data-mode="transfer"]{ color: var(--transfer); }

/* â”€â”€ CONTENT â”€â”€ */
.content { flex: 1; padding: 16px 20px 0; display: flex; flex-direction: column; gap: 12px; }

/* â”€â”€ SCREENS â”€â”€ */
.screen { display: none; flex-direction: column; gap: 12px; }
.screen.active { display: flex; animation: fadeUp 0.2s cubic-bezier(0.22,1,0.36,1); }
@keyframes fadeUp { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

/* â”€â”€ UPLOAD HERO â”€â”€ */
.upload-hero { min-height: 260px; background: var(--surface); border: 1.5px dashed var(--border2); border-radius: 20px; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 14px; cursor: pointer; transition: all 0.2s ease; position: relative; overflow: hidden; }
.upload-hero::before { content: ''; position: absolute; inset: 0; background: radial-gradient(ellipse at 50% 0%, rgba(42,157,159,0.07) 0%, transparent 70%); pointer-events: none; }
.upload-hero:hover, .upload-hero.drag { border-color: var(--accent); background: var(--accent-dim); }
.upload-hero:active { transform: scale(0.985); }
.upload-icon { width: 60px; height: 60px; border-radius: 16px; background: var(--surface2); border: 1px solid var(--border2); display: flex; align-items: center; justify-content: center; font-size: 26px; transition: transform 0.2s; }
.upload-hero:active .upload-icon { transform: scale(0.9); }
.upload-label { font-family: 'Space Grotesk', sans-serif; font-size: 17px; font-weight: 600; }
.upload-sub { font-size: 13px; color: var(--muted); }
#file-input { display: none; }

/* â”€â”€ PARSING â”€â”€ */
.parsing-screen { min-height: 260px; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 16px; background: var(--surface); border: 1px solid var(--border); border-radius: 20px; }
.pulse-ring { width: 48px; height: 48px; position: relative; display: flex; align-items: center; justify-content: center; }
.pulse-ring::before, .pulse-ring::after { content: ''; position: absolute; border: 1.5px solid var(--accent); border-radius: 50%; animation: pulse-out 1.4s ease-out infinite; }
.pulse-ring::after { animation-delay: 0.55s; }
@keyframes pulse-out { 0% { width: 14px; height: 14px; opacity: 0.9; } 100% { width: 48px; height: 48px; opacity: 0; } }
.pulse-dot { width: 10px; height: 10px; border-radius: 50%; background: var(--accent); z-index: 1; }
.parsing-text { font-size: 13px; color: var(--text2); letter-spacing: 0.01em; }

/* â”€â”€ RECEIPT â”€â”€ */
.receipt { background: var(--surface); border: 1px solid var(--border); border-radius: 20px; overflow: hidden; }

.receipt-hero { padding: 22px 22px 18px; border-bottom: 1px dashed var(--border2); transition: background 0.3s; }
.receipt-hero.expense-bg  { background: rgba(255,92,92,0.04); }
.receipt-hero.income-bg   { background: rgba(42,157,159,0.06); }
.receipt-hero.transfer-bg { background: rgba(155,143,255,0.04); }

.hero-amount-wrap { display: flex; align-items: flex-start; gap: 8px; margin-bottom: 12px; }
.receipt-amount { font-family: 'Space Grotesk', sans-serif; font-size: 36px; font-weight: 700; letter-spacing: -0.02em; line-height: 1; cursor: pointer; border-bottom: 1.5px dashed transparent; transition: border-color 0.15s; flex: 1; }
.receipt-amount:hover { border-bottom-color: var(--border2); }
.receipt-amount.expense  { color: var(--expense); }
.receipt-amount.income   { color: var(--income); }
.receipt-amount.transfer { color: var(--transfer); }
.receipt-amount-input { font-family: 'Space Grotesk', sans-serif; font-size: 36px; font-weight: 700; letter-spacing: -0.02em; line-height: 1; background: transparent; border: none; outline: none; width: 100%; }
.receipt-amount-input.expense  { color: var(--expense); }
.receipt-amount-input.income   { color: var(--income); }

.type-chip { font-family: 'DM Mono', monospace; font-size: 9px; letter-spacing: 0.1em; text-transform: uppercase; padding: 3px 7px; border-radius: 6px; font-weight: 500; margin-top: 6px; flex-shrink: 0; }
.type-chip.expense  { background: var(--danger-dim);   color: var(--expense);  border: 1px solid var(--danger-border); }
.type-chip.income   { background: var(--accent-dim);   color: var(--income);   border: 1px solid var(--accent-border); }
.type-chip.transfer { background: var(--transfer-dim); color: var(--transfer); border: 1px solid rgba(184,169,224,0.25); }

.receipt-meta { display: flex; align-items: center; gap: 10px; }
.receipt-merchant-wrap { flex: 1; }
.receipt-merchant { font-size: 15px; font-weight: 600; color: var(--text); cursor: pointer; border-bottom: 1.5px dashed transparent; display: inline-block; transition: border-color 0.15s; }
.receipt-merchant:hover { border-bottom-color: var(--border2); }
.merchant-input { font-size: 15px; font-weight: 600; background: transparent; border: none; border-bottom: 1.5px solid var(--accent-border); outline: none; color: var(--text); width: 100%; padding-bottom: 1px; }
.receipt-date { font-family: 'DM Mono', monospace; font-size: 11px; color: var(--muted); cursor: pointer; border-bottom: 1.5px dashed transparent; transition: border-color 0.15s; white-space: nowrap; }
.receipt-date:hover { border-bottom-color: var(--border2); }
.date-input { font-family: 'DM Mono', monospace; font-size: 11px; background: transparent; border: none; border-bottom: 1.5px solid var(--accent-border); outline: none; color: var(--text2); width: 90px; }

/* â”€â”€ WARN BANNER â”€â”€ */
.warn-banner { background: var(--warn-dim); border: 1px solid var(--warn-border); border-radius: 10px; padding: 8px 14px; font-size: 12px; color: var(--warn); display: flex; align-items: center; gap: 6px; }

/* â”€â”€ FIELD ROWS â”€â”€ */
.field-section { padding: 2px 0; }
.field-row { display: grid; grid-template-columns: 76px 1fr; align-items: center; padding: 10px 22px; border-bottom: 1px solid var(--border); min-height: 46px; gap: 12px; }
.field-row:last-child { border-bottom: none; }
.field-key { font-family: 'DM Mono', monospace; font-size: 10px; letter-spacing: 0.08em; text-transform: uppercase; color: var(--muted); }
.field-val { font-size: 14px; font-weight: 500; color: var(--text); text-align: right; }
.field-val.group-tag { display: flex; justify-content: flex-end; }
.group-badge { font-family: 'DM Mono', monospace; font-size: 10px; background: var(--surface3); border: 1px solid var(--border2); border-radius: 6px; padding: 2px 8px; color: var(--text2); letter-spacing: 0.04em; }
.auto-badge { font-family: 'DM Mono', monospace; font-size: 9px; background: var(--accent-dim); border: 1px solid var(--accent-border); border-radius: 5px; padding: 2px 6px; color: var(--accent); letter-spacing: 0.04em; margin-left: 6px; }

.inline-input { background: transparent; border: none; outline: none; font-family: 'DM Sans', sans-serif; font-size: 14px; font-weight: 500; color: var(--text); text-align: right; width: 100%; }
.inline-input::placeholder { color: var(--muted); }
.char-count { font-size: 10px; color: var(--muted); text-align: right; margin-top: 2px; font-family: 'DM Mono', monospace; }

/* â”€â”€ SEARCHABLE DROPDOWN â”€â”€ */
.dropdown-wrap { position: relative; width: 100%; }
.dropdown-input { background: transparent; border: none; outline: none; font-family: 'DM Sans', sans-serif; font-size: 14px; font-weight: 500; color: var(--text); text-align: right; width: 100%; cursor: pointer; }
.dropdown-input::placeholder { color: var(--muted); }
.dropdown-list { position: absolute; right: 0; top: calc(100% + 6px); background: var(--surface2); border: 1px solid var(--border2); border-radius: 12px; max-height: 200px; overflow-y: auto; z-index: 50; min-width: 180px; box-shadow: 0 8px 32px rgba(0,0,0,0.4); animation: dropIn 0.15s cubic-bezier(0.22,1,0.36,1); }
@keyframes dropIn { from { opacity: 0; transform: translateY(-4px) scale(0.97); } to { opacity: 1; transform: translateY(0) scale(1); } }
.dropdown-item { padding: 10px 14px; font-size: 13px; cursor: pointer; color: var(--text); transition: background 0.1s; }
.dropdown-item:hover, .dropdown-item.highlighted { background: var(--surface3); }
.dropdown-item.selected { color: var(--accent); }
.dropdown-empty { padding: 10px 14px; font-size: 12px; color: var(--muted); text-align: center; }

/* â”€â”€ NATIVE SELECT FALLBACK â”€â”€ */
.inline-select { background: var(--surface2); border: 1px solid var(--border2); border-radius: 8px; color: var(--text); font-family: 'DM Sans', sans-serif; font-size: 13px; padding: 6px 10px; width: 100%; outline: none; text-align: right; }

/* â”€â”€ DUPE WARNING â”€â”€ */
.dupe-card { background: var(--warn-dim); border: 1px solid var(--warn-border); border-radius: 14px; padding: 14px 18px; display: flex; flex-direction: column; gap: 10px; }
.dupe-title { font-family: 'Space Grotesk', sans-serif; font-size: 14px; font-weight: 600; color: var(--warn); }
.dupe-desc { font-size: 12px; color: var(--text2); line-height: 1.5; }
.dupe-actions { display: flex; gap: 8px; }
.btn-dupe-log { flex: 1; padding: 10px; border-radius: 10px; background: var(--warn); color: #061414; font-family: 'Space Grotesk', sans-serif; font-size: 13px; font-weight: 600; border: none; cursor: pointer; }
.btn-dupe-cancel { flex: 1; padding: 10px; border-radius: 10px; background: var(--surface2); border: 1px solid var(--border2); color: var(--text2); font-family: 'Space Grotesk', sans-serif; font-size: 13px; font-weight: 600; cursor: pointer; }

/* â”€â”€ ACTIONS â”€â”€ */
.action-bar { display: flex; gap: 10px; }
.btn { flex: 1; padding: 16px; border-radius: 14px; font-family: 'Space Grotesk', sans-serif; font-size: 15px; font-weight: 600; border: none; cursor: pointer; transition: all 0.15s; letter-spacing: -0.01em; position: relative; overflow: hidden; }
.btn::after { content: ''; position: absolute; inset: 0; background: white; opacity: 0; transition: opacity 0.15s; border-radius: inherit; }
.btn:active::after { opacity: 0.08; }
.btn-log { background: var(--accent); color: #051010; }
.btn-log:hover { filter: brightness(1.08); }
.btn-log:active { transform: scale(0.96); }
.btn-ghost { background: var(--surface); border: 1px solid var(--border); color: var(--text2); }
.btn-ghost:hover { border-color: var(--border2); color: var(--text); }
.btn-ghost:active { transform: scale(0.97); }

/* â”€â”€ FAILURE â”€â”€ */
.failure-card { background: var(--danger-dim); border: 1px solid var(--danger-border); border-radius: 16px; padding: 20px; display: flex; flex-direction: column; gap: 12px; }
.failure-title { font-family: 'Space Grotesk', sans-serif; font-size: 15px; font-weight: 600; color: var(--danger); }
.failure-desc { font-size: 13px; color: var(--text2); line-height: 1.5; }
.failure-actions { display: flex; gap: 8px; }
.btn-retry { flex: 1; padding: 12px; border-radius: 10px; background: var(--danger); color: #fff; font-family: 'Space Grotesk', sans-serif; font-size: 14px; font-weight: 600; border: none; cursor: pointer; transition: all 0.15s; }
.btn-copy  { flex: 1; padding: 12px; border-radius: 10px; background: var(--surface2); border: 1px solid var(--border2); color: var(--text2); font-family: 'Space Grotesk', sans-serif; font-size: 14px; font-weight: 600; cursor: pointer; }
.btn-retry:active, .btn-copy:active { transform: scale(0.96); }

/* â”€â”€ SUCCESS â”€â”€ */
.success-card { background: var(--accent-dim); border: 1px solid var(--accent-border); border-radius: 20px; padding: 32px 20px; display: flex; flex-direction: column; align-items: center; gap: 8px; text-align: center; animation: successPop 0.35s cubic-bezier(0.34,1.56,0.64,1); }
@keyframes successPop { from { opacity: 0; transform: scale(0.88); } to { opacity: 1; transform: scale(1); } }
.success-check { width: 52px; height: 52px; border-radius: 50%; background: var(--accent); display: flex; align-items: center; justify-content: center; font-size: 22px; color: #061414; margin-bottom: 4px; animation: checkPop 0.4s 0.1s cubic-bezier(0.34,1.56,0.64,1) both; }
@keyframes checkPop { from { transform: scale(0); } to { transform: scale(1); } }
.success-label { font-family: 'Space Grotesk', sans-serif; font-size: 18px; font-weight: 700; color: var(--accent); }
.success-detail { display: flex; flex-direction: column; gap: 4px; margin-top: 4px; }
.success-row { font-size: 13px; color: var(--text2); }
.success-row strong { color: var(--text); font-weight: 600; }

/* â”€â”€ MANUAL FORM â”€â”€ */
.form-block { background: var(--surface); border: 1px solid var(--border); border-radius: 16px; overflow: hidden; }
.form-row-inner { display: grid; grid-template-columns: 76px 1fr; align-items: center; padding: 12px 22px; border-bottom: 1px solid var(--border); min-height: 48px; gap: 12px; }
.form-row-inner:last-child { border-bottom: none; }
.form-key { font-family: 'DM Mono', monospace; font-size: 10px; letter-spacing: 0.08em; text-transform: uppercase; color: var(--muted); }
.form-ctrl { background: transparent; border: none; outline: none; font-family: 'DM Sans', sans-serif; font-size: 14px; font-weight: 500; color: var(--text); text-align: right; width: 100%; }
.form-ctrl::placeholder { color: var(--muted); }
.form-select-ctrl { background: transparent; border: none; outline: none; font-family: 'DM Sans', sans-serif; font-size: 14px; color: var(--text); text-align: right; width: 100%; cursor: pointer; }
.form-readonly { background: transparent; border: none; outline: none; font-family: 'DM Sans', sans-serif; font-size: 14px; color: var(--muted); text-align: right; width: 100%; cursor: default; }

/* â”€â”€ TRANSFER NOTICE â”€â”€ */
.transfer-notice { background: var(--transfer-dim); border: 1px solid rgba(184,169,224,0.2); border-radius: 12px; padding: 10px 14px; font-size: 12px; color: var(--transfer); }

/* â”€â”€ SETTINGS â”€â”€ */
.overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.75); backdrop-filter: blur(8px); z-index: 100; display: none; align-items: flex-end; justify-content: center; }
.overlay.open { display: flex; }
.sheet { width: 100%; max-width: 430px; background: var(--surface); border-radius: 24px 24px 0 0; border: 1px solid var(--border); border-bottom: none; padding: 12px 20px 52px; display: flex; flex-direction: column; gap: 14px; animation: slideUp 0.25s cubic-bezier(0.22,1,0.36,1); }
@keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
.sheet-handle { width: 36px; height: 4px; background: var(--border2); border-radius: 2px; margin: 0 auto 4px; }
.sheet-title { font-family: 'Space Grotesk', sans-serif; font-size: 17px; font-weight: 700; }
.setting-group { display: flex; flex-direction: column; gap: 6px; }
.setting-label { font-family: 'DM Mono', monospace; font-size: 10px; color: var(--muted); letter-spacing: 0.1em; text-transform: uppercase; }
.setting-input { background: var(--surface2); border: 1px solid var(--border); border-radius: 10px; color: var(--text); font-family: 'DM Mono', monospace; font-size: 13px; padding: 12px 14px; outline: none; transition: border-color 0.15s; width: 100%; }
.setting-input:focus { border-color: var(--accent-border); }
.setting-hint { font-size: 11px; color: var(--muted); line-height: 1.6; }
</style>
</head>
<body>
<div class="app">
  <div class="topbar">
    <div class="wordmark">YNA<span>B</span></div>
    <div class="gear-btn" onclick="openSettings()">âš™</div>
  </div>

  <div class="mode-strip">
    <div class="pills">
      <div class="pill active" data-mode="expense"  onclick="selectMode('expense')">Expense</div>
      <div class="pill"        data-mode="income"   onclick="selectMode('income')">Income</div>
      <div class="pill"        data-mode="transfer" onclick="selectMode('transfer')">Transfer</div>
      <div class="pill"        data-mode="manual"   onclick="selectMode('manual')">Manual</div>
    </div>
  </div>

  <div class="content">

    <!-- UPLOAD -->
    <div class="screen active" id="screen-upload">
      <div class="upload-hero" id="upload-hero" onclick="document.getElementById('file-input').click()">
        <div class="upload-icon" id="upload-icon">ðŸ“·</div>
        <div class="upload-label" id="upload-label">Share a screenshot</div>
        <div class="upload-sub"   id="upload-sub">GCash, credit card, any bank app</div>
      </div>
      <input type="file" id="file-input" accept="image/*" onchange="handleFile(event)">
    </div>

    <!-- PARSING -->
    <div class="screen" id="screen-parsing">
      <div class="parsing-screen">
        <div class="pulse-ring"><div class="pulse-dot"></div></div>
        <div class="parsing-text">Reading screenshotâ€¦</div>
      </div>
    </div>

    <!-- CONFIRM -->
    <div class="screen" id="screen-confirm">
      <div class="receipt" id="receipt-card">
        <div class="receipt-hero" id="receipt-hero">
          <div class="hero-amount-wrap">
            <div class="receipt-amount" id="r-amount" onclick="editAmount()">â‚±0.00</div>
            <div class="type-chip" id="r-type-chip">expense</div>
          </div>
          <div class="receipt-meta">
            <div class="receipt-merchant-wrap">
              <div class="receipt-merchant" id="r-merchant" onclick="editMerchant()">â€”</div>
            </div>
            <div class="receipt-date" id="r-date" onclick="editDate()">â€”</div>
          </div>
        </div>
        <div id="warn-banner-wrap"></div>
        <div class="field-section" id="r-fields"></div>
      </div>
      <div id="dupe-warn-wrap"></div>
      <div id="transfer-notice" class="transfer-notice" style="display:none">â†• Logs 2 rows â€” outgoing and incoming.</div>
      <div class="action-bar">
        <div class="btn btn-ghost" onclick="cancelConfirm()">Retake</div>
        <div class="btn btn-log"   id="btn-log-it" onclick="handleLogIt()">Log It</div>
      </div>
    </div>

    <!-- FAILURE -->
    <div class="screen" id="screen-failure">
      <div class="failure-card">
        <div class="failure-title">Failed to log</div>
        <div class="failure-desc">Transaction didn't reach your Sheet. Your data is safe â€” retry or copy it to paste manually.</div>
        <div class="failure-actions">
          <button class="btn-retry" onclick="retryLog()">Retry</button>
          <button class="btn-copy"  onclick="copyFailed()">Copy row</button>
        </div>
      </div>
      <div class="btn btn-ghost" onclick="cancelConfirm()">Start over</div>
    </div>

    <!-- SUCCESS -->
    <div class="screen" id="screen-success">
      <div class="success-card">
        <div class="success-check">âœ“</div>
        <div class="success-label" id="success-label">Logged</div>
        <div class="success-detail" id="success-detail"></div>
      </div>
    </div>

    <!-- MANUAL -->
    <div class="screen" id="screen-manual">
      <div class="form-block" id="manual-form"></div>
      <div class="action-bar">
        <div class="btn btn-ghost" onclick="cancelConfirm()">Cancel</div>
        <div class="btn btn-log"   onclick="submitManual()">Log It</div>
      </div>
    </div>

  </div>
</div>

<!-- SETTINGS -->
<div class="overlay" id="overlay" onclick="closeSettings(event)">
  <div class="sheet">
    <div class="sheet-handle"></div>
    <div class="sheet-title">Settings</div>
    <div class="setting-group">
      <div class="setting-label">Gemini API Key</div>
      <input class="setting-input" type="password" id="s-gemini" placeholder="AIzaâ€¦" oninput="saveSetting('gemini',this.value)">
    </div>
    <div class="setting-group">
      <div class="setting-label">Google Sheet ID</div>
      <input class="setting-input" type="text" id="s-sheetid" placeholder="Sheet ID from URL" oninput="saveSetting('sheetId',this.value)">
    </div>
    <div class="setting-group">
      <div class="setting-label">Google API Key</div>
      <input class="setting-input" type="password" id="s-googleapi" placeholder="AIzaâ€¦" oninput="saveSetting('googleApi',this.value)">
      <div class="setting-hint">Needs Sheets API enabled. Free at console.cloud.google.com.</div>
    </div>
    <div class="btn btn-log" onclick="closeSettings()">Done</div>
  </div>
</div>

<script>
// â”€â”€ CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

const SHEET_TAB = 'Log';
const WEBHOOK   = 'https://script.google.com/macros/s/AKfycbwfl8-4sVKehGHxjGJirXVOYoTOZyinPFijxhQxJVVZQbWFaeBv53hr5HHuoPzYCg5z-Q/exec';
const GEMINI_KEY_DEFAULT    = 'AIzaSyAANRw1Y4A3vv2B13vA3lnbWr5iUYn9QPI';
const SHEET_ID_DEFAULT      = '15G5abgmSIE-kYkh0LI3FtWXPO2DlvVgUnWmAcn36nE0';

// â”€â”€ DATA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

const CATEGORY_MAP = {
  'Salary':'Income','IOU':'Income',
  'Electricity':'Home','Groceries':'Home','Lulay':'Home',
  'Pet Food':'Pets','Grooming':'Pets','Litter':'Pets','Misc':'Pets','Vet':'Pets',
  'Doctor':'Health','Supplements':'Health','Therapy':'Health','Medicine':'Health','Lab Tests':'Health','Eyes':'Health',
  'Cellphone':'Quality Of Life','Eating Out':'Quality Of Life','Car':'Quality Of Life','Self Care':'Quality Of Life',
  'Social':'Quality Of Life','Shopping':'Quality Of Life','Transpo':'Quality Of Life','Others':'Quality Of Life',
  'Stellar Rebels':'Stellar Rebels',
  'Digital Subscriptions':'Sinking','Gifts':'Sinking','Car Maintenance':'Sinking','Home Maintenance':'Sinking',
  'Family Emergency':'Emergency','Medical Emergency':'Emergency','Pet Emergency':'Emergency','Job Loss':'Emergency',
  'Tech Fund':'Goals','Beauty Fund':'Goals','Vacation Fund':'Goals',
};

const INCOME_CATS     = ['Salary','IOU'];
const EXPENSE_CATS    = Object.keys(CATEGORY_MAP).filter(c => !INCOME_CATS.includes(c));
const PAYMENT_METHODS = ['GCash','Maribank','BDO','BPI','Maya','UnionBank','UnionBank Credit','Cash'];
const REVIEW_OPTIONS  = ['Myself','Others','Both','Other'];

// Merchant intelligence: keyword â†’ { paymentMethod, category (optional) }
const MERCHANT_RULES = [
  { keywords: ['grab'],              paymentMethod: 'UnionBank Credit', category: null },
  { keywords: ['indrive','in drive'],paymentMethod: 'Cash',             category: null },
  { keywords: ['shopee'],            paymentMethod: 'Maribank',          category: null },
  { keywords: ['lazada'],            paymentMethod: 'UnionBank Credit', category: null },
  { keywords: ['app store','apple'], paymentMethod: 'UnionBank Credit', category: 'Digital Subscriptions' },
  { keywords: ['google play','play store'], paymentMethod: 'UnionBank Credit', category: 'Digital Subscriptions' },
  { keywords: ['netflix'],           paymentMethod: 'UnionBank Credit', category: 'Digital Subscriptions' },
  { keywords: ['spotify'],           paymentMethod: 'UnionBank Credit', category: 'Digital Subscriptions' },
  { keywords: ['youtube premium'],   paymentMethod: 'UnionBank Credit', category: 'Digital Subscriptions' },
  { keywords: ['canva'],             paymentMethod: 'UnionBank Credit', category: 'Digital Subscriptions' },
  { keywords: ['adobe'],             paymentMethod: 'UnionBank Credit', category: 'Digital Subscriptions' },
];

// â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

let currentMode     = localStorage.getItem('lastMode') || 'expense';
let parsedData      = {};
let lastFailedRows  = null;
let lastLoggedKey   = null;
let lastLoggedTime  = 0;
let activeDropdown  = null;
let pendingRows     = null;

// â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

localStorage.getItem('gemini')    || localStorage.setItem('gemini',    GEMINI_KEY_DEFAULT);
localStorage.getItem('sheetId')   || localStorage.setItem('sheetId',   SHEET_ID_DEFAULT);

function loadSettings() {
  document.getElementById('s-gemini').value    = localStorage.getItem('gemini')    || '';
  document.getElementById('s-sheetid').value   = localStorage.getItem('sheetId')   || '';
  document.getElementById('s-googleapi').value = localStorage.getItem('googleApi') || '';
}
function saveSetting(k,v) { localStorage.setItem(k,v); }
function openSettings()   { loadSettings(); document.getElementById('overlay').classList.add('open'); }
function closeSettings(e) { if (!e || e.target===document.getElementById('overlay')) document.getElementById('overlay').classList.remove('open'); }

// â”€â”€ UTILITIES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function haptic(style='light') {
  if (navigator.vibrate) {
    const map = { light:30, medium:60, success:[30,50,30], error:[60,30,60] };
    navigator.vibrate(map[style]||30);
  }
}

function fmt(n) {
  return 'â‚±' + Number(n).toLocaleString('en-PH', { minimumFractionDigits:2, maximumFractionDigits:2 });
}

function toSheetDate(isoOrRaw) {
  // Convert YYYY-MM-DD â†’ M/D/YYYY
  const d = new Date(isoOrRaw + 'T00:00:00');
  if (isNaN(d)) return isoOrRaw;
  return `${d.getMonth()+1}/${d.getDate()}/${d.getFullYear()}`;
}

function todayISO() {
  const d = new Date();
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
}

function todayDisplay() {
  return new Date().toLocaleDateString('en-US', { month:'short', day:'numeric' });
}

function displayDate(iso) {
  const d = new Date(iso + 'T00:00:00');
  if (isNaN(d)) return iso;
  return d.toLocaleDateString('en-US', { month:'short', day:'numeric' });
}

function applyMerchantRules(merchant) {
  if (!merchant) return {};
  const lower = merchant.toLowerCase();
  for (const rule of MERCHANT_RULES) {
    if (rule.keywords.some(k => lower.includes(k))) {
      return { paymentMethod: rule.paymentMethod, category: rule.category };
    }
  }
  return {};
}

// â”€â”€ SCREENS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function show(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  closeAllDropdowns();
}

function cancelConfirm() {
  parsedData = {}; lastFailedRows = null; pendingRows = null;
  document.getElementById('dupe-warn-wrap').innerHTML = '';
  refreshHero();
  show('screen-upload');
}

// â”€â”€ MODE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function selectMode(mode) {
  currentMode = mode;
  localStorage.setItem('lastMode', mode);
  document.querySelectorAll('.pill').forEach(p => p.classList.toggle('active', p.dataset.mode === mode));
  if (mode === 'transfer' || mode === 'manual') { buildManualForm(mode); show('screen-manual'); }
  else { refreshHero(); show('screen-upload'); }
}

function refreshHero() {
  const map = {
    expense: { icon:'ðŸ“·', label:'Share a screenshot', sub:'GCash, credit card, any bank app' },
    income:  { icon:'ðŸ“¥', label:'Share a screenshot', sub:'Salary slip, GCash, any inflow' },
  };
  const d = map[currentMode] || map.expense;
  document.getElementById('upload-icon').textContent  = d.icon;
  document.getElementById('upload-label').textContent = d.label;
  document.getElementById('upload-sub').textContent   = d.sub;
}

// â”€â”€ FILE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function handleFile(e) {
  const file = e.target.files[0]; if (!file) return;
  e.target.value = '';
  const reader = new FileReader();
  reader.onload = () => parseWithGemini(reader.result);
  reader.readAsDataURL(file);
}

// â”€â”€ GEMINI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function parseWithGemini(dataUrl) {
  const rawKey = localStorage.getItem('gemini') || '';
  const apiKey = rawKey.trim().replace(/[^A-Za-z0-9_\-]/g, '');
  if (!apiKey || apiKey.length < 20) { alert('Gemini API key is missing or invalid. Check Settings.'); return; }
  show('screen-parsing');

  const cats  = currentMode === 'income' ? INCOME_CATS.join(', ') : EXPENSE_CATS.join(', ');
  const today = todayISO();

  const prompt = `Extract transaction data from this Filipino payment app screenshot.
Return ONLY valid JSON â€” no markdown, no explanation:
{"amount":number,"date":"YYYY-MM-DD","merchant":"string","payment_method":"one of: GCash, Credit Card, Maribank, BDO, BPI, Maya, UnionBank, UnionBank Credit, Cash","category":"one of: ${cats}","low_confidence":boolean}

Rules:
- amount is always positive
- Default payment_method to GCash if unclear
- Pick the closest category from the provided list only
- If date is unclear use ${today}
- Set low_confidence to true if you are unsure about any field
- If screenshot has no recognizable transaction, return {"error":"no_transaction"}`;

  const base64   = dataUrl.split(',')[1];
  const mimeType = dataUrl.split(';')[0].split(':')[1];

  try {
    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        contents: [{ parts: [{ text: prompt }, { inline_data: { mime_type: mimeType, data: base64 } }] }],
        generationConfig: { maxOutputTokens: 400, temperature: 0.1 }
      })
    });

    const data   = await res.json();
    if (!res.ok) {
      console.error('Gemini error:', JSON.stringify(data));
      throw new Error(`Gemini ${res.status}: ${data?.error?.message || 'unknown'}`);
    }
    const raw    = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
    const parsed = JSON.parse(raw.replace(/```json|```/g,'').trim());

    if (parsed.error === 'no_transaction') {
      alert('No transaction found in this screenshot. Try a different image or use Manual.');
      show('screen-upload');
      return;
    }

    // Apply merchant intelligence
    const rules = applyMerchantRules(parsed.merchant);
    const paymentMethod = rules.paymentMethod || parsed.payment_method;
    const category      = rules.category      || parsed.category;

    parsedData = {
      type:          currentMode === 'income' ? 'Income' : 'Expense',
      amount:        parsed.amount,
      date:          parsed.date || today,
      merchant:      parsed.merchant,
      paymentMethod,
      category,
      group:         CATEGORY_MAP[category] || '',
      memo:          '',
      review:        'Myself',
      lowConfidence: parsed.low_confidence || false,
      autoPayment:   !!rules.paymentMethod,
      autoCategory:  !!rules.category,
    };

    buildReceiptCard();
    show('screen-confirm');
    haptic('light');
  } catch(err) {
    console.error(err);
    alert('Could not parse screenshot. Try again or use Manual.');
    show('screen-upload');
  }
}

// â”€â”€ RECEIPT CARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function buildReceiptCard() {
  const d = parsedData;

  // Hero
  const amtEl = document.getElementById('r-amount');
  amtEl.textContent = fmt(d.amount);
  amtEl.className   = `receipt-amount ${d.type.toLowerCase()}`;

  const hero = document.getElementById('receipt-hero');
  hero.className = `receipt-hero ${d.type.toLowerCase()}-bg`;

  const chip = document.getElementById('r-type-chip');
  chip.textContent = d.type.toLowerCase();
  chip.className   = `type-chip ${d.type.toLowerCase()}`;

  document.getElementById('r-merchant').textContent = d.merchant || 'â€”';
  document.getElementById('r-date').textContent     = displayDate(d.date);

  // Warn banner
  const warnWrap = document.getElementById('warn-banner-wrap');
  warnWrap.innerHTML = d.lowConfidence
    ? `<div class="warn-banner" style="margin:0 0 0 0;border-radius:0;border-left:none;border-right:none;border-top:none;">âš  Low confidence â€” review fields carefully</div>`
    : '';

  // Fields
  const cats   = d.type === 'Income' ? INCOME_CATS : EXPENSE_CATS;
  const fields = [
    { key:'Via',      dataKey:'paymentMethod', type:'select',   options:PAYMENT_METHODS, auto: d.autoPayment },
    { key:'Category', dataKey:'category',      type:'dropdown', options:cats,             auto: d.autoCategory },
    { key:'Group',    dataKey:'group',          type:'badge' },
    { key:'Memo',     dataKey:'memo',           type:'text' },
    { key:'Review',   dataKey:'review',         type:'select',   options:REVIEW_OPTIONS },
  ];

  const container = document.getElementById('r-fields');
  container.innerHTML = '';

  fields.forEach(f => {
    const row = document.createElement('div');
    row.className   = 'field-row';
    row.dataset.key = f.dataKey;

    if (f.type === 'badge') {
      row.innerHTML = `
        <div class="field-key">${f.key}</div>
        <div class="field-val group-tag"><span class="group-badge" id="badge-group">${d[f.dataKey]||'â€”'}</span></div>`;

    } else if (f.type === 'text') {
      row.innerHTML = `
        <div class="field-key">${f.key}</div>
        <div style="display:flex;flex-direction:column;align-items:flex-end;flex:1">
          <input class="inline-input" id="field-memo" maxlength="60" value="${d[f.dataKey]||''}" placeholder="Optional"
            oninput="updateField('${f.dataKey}',this.value);updateCharCount(this)"
            onfocus="updateCharCount(this)">
          <div class="char-count" id="memo-count" style="display:none"></div>
        </div>`;

    } else if (f.type === 'dropdown') {
      const autoBadge = f.auto ? `<span class="auto-badge">auto</span>` : '';
      row.innerHTML = `
        <div class="field-key">${f.key}</div>
        <div class="dropdown-wrap" id="dd-wrap-${f.dataKey}">
          <input class="dropdown-input" id="dd-${f.dataKey}" value="${d[f.dataKey]||''}" placeholder="Type to searchâ€¦"
            autocomplete="off"
            oninput="filterDropdown('${f.dataKey}', this.value)"
            onfocus="openDropdown('${f.dataKey}')"
            onkeydown="dropdownKeyNav(event,'${f.dataKey}')">
          ${autoBadge}
          <div class="dropdown-list" id="ddlist-${f.dataKey}" style="display:none"></div>
        </div>`;

    } else if (f.type === 'select') {
      const autoBadge = f.auto ? `<span class="auto-badge">auto</span>` : '';
      const opts = f.options.map(o=>`<option ${d[f.dataKey]===o?'selected':''}>${o}</option>`).join('');
      row.innerHTML = `
        <div class="field-key">${f.key}</div>
        <div style="display:flex;align-items:center;justify-content:flex-end;gap:6px;flex:1">
          ${autoBadge}
          <select class="inline-select" style="width:auto" onchange="updateField('${f.dataKey}',this.value)">${opts}</select>
        </div>`;
    }

    container.appendChild(row);
  });

  // Populate dropdowns after DOM insert
  if (document.getElementById('ddlist-category')) {
    renderDropdownList('category', cats, d.category);
  }
}

// â”€â”€ HERO INLINE EDITING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function editAmount() {
  const el = document.getElementById('r-amount');
  const raw = parsedData.amount || 0;
  el.outerHTML = `<input class="receipt-amount-input ${parsedData.type.toLowerCase()}" id="r-amount-input"
    type="text" inputmode="decimal" value="${raw}"
    onblur="commitAmount(this.value)"
    onkeydown="if(event.key==='Enter')this.blur()">`;
  setTimeout(() => { const inp = document.getElementById('r-amount-input'); if(inp){inp.focus();inp.select();} }, 50);
}

function commitAmount(val) {
  const num = parseFloat(val.replace(/,/g,'')) || 0;
  parsedData.amount = num;
  const wrap = document.getElementById('r-amount-input') || document.querySelector('.receipt-amount-input');
  if (wrap) {
    const div = document.createElement('div');
    div.className = `receipt-amount ${parsedData.type.toLowerCase()}`;
    div.id = 'r-amount';
    div.textContent = fmt(num);
    div.onclick = editAmount;
    wrap.replaceWith(div);
  }
}

function editMerchant() {
  const el = document.getElementById('r-merchant');
  el.outerHTML = `<input class="merchant-input" id="merchant-input" value="${parsedData.merchant||''}"
    onblur="commitMerchant(this.value)"
    onkeydown="if(event.key==='Enter')this.blur()">`;
  setTimeout(() => { const inp = document.getElementById('merchant-input'); if(inp){inp.focus();inp.select();} }, 50);
}

function commitMerchant(val) {
  parsedData.merchant = val;
  const inp = document.getElementById('merchant-input');
  if (inp) {
    const div = document.createElement('div');
    div.className = 'receipt-merchant';
    div.id = 'r-merchant';
    div.textContent = val || 'â€”';
    div.onclick = editMerchant;
    inp.replaceWith(div);
  }
  // Re-apply merchant rules
  const rules = applyMerchantRules(val);
  if (rules.paymentMethod) {
    parsedData.paymentMethod = rules.paymentMethod;
    parsedData.autoPayment   = true;
    const sel = document.querySelector('[data-key="paymentMethod"] select');
    if (sel) sel.value = rules.paymentMethod;
  }
}

function editDate() {
  const el = document.getElementById('r-date');
  el.outerHTML = `<input class="date-input" id="date-input" type="date" value="${parsedData.date||todayISO()}"
    onblur="commitDate(this.value)"
    onchange="commitDate(this.value)">`;
  setTimeout(() => { const inp = document.getElementById('date-input'); if(inp) inp.focus(); }, 50);
}

function commitDate(val) {
  parsedData.date = val;
  const inp = document.getElementById('date-input');
  if (inp) {
    const div = document.createElement('div');
    div.className = 'receipt-date';
    div.id = 'r-date';
    div.textContent = displayDate(val);
    div.onclick = editDate;
    inp.replaceWith(div);
  }
}

// â”€â”€ DROPDOWN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function renderDropdownList(key, options, selected, filter='') {
  const list = document.getElementById(`ddlist-${key}`);
  if (!list) return;
  const filtered = filter
    ? options.filter(o => o.toLowerCase().includes(filter.toLowerCase()))
    : options;

  if (!filtered.length) {
    list.innerHTML = `<div class="dropdown-empty">No match</div>`;
    list.style.display = 'block';
    return;
  }

  list.innerHTML = filtered.map((o,i) =>
    `<div class="dropdown-item ${o===selected?'selected':''}" data-idx="${i}" data-val="${o}"
      onmousedown="selectDropdownItem('${key}','${o}')">${o}</div>`
  ).join('');
  list.style.display = 'block';
}

function openDropdown(key) {
  const cats = parsedData.type === 'Income' ? INCOME_CATS : EXPENSE_CATS;
  renderDropdownList(key, cats, parsedData[key] || '');
  activeDropdown = key;
}

function filterDropdown(key, val) {
  const cats = parsedData.type === 'Income' ? INCOME_CATS : EXPENSE_CATS;
  renderDropdownList(key, cats, parsedData[key] || '', val);
}

function selectDropdownItem(key, val) {
  updateField(key, val);
  const inp = document.getElementById(`dd-${key}`);
  if (inp) inp.value = val;
  const list = document.getElementById(`ddlist-${key}`);
  if (list) list.style.display = 'none';
  activeDropdown = null;
  haptic('light');
}

function dropdownKeyNav(e, key) {
  const list = document.getElementById(`ddlist-${key}`);
  if (!list || list.style.display === 'none') return;
  const items = list.querySelectorAll('.dropdown-item');
  const current = list.querySelector('.highlighted');
  let idx = current ? parseInt(current.dataset.idx) : -1;

  if (e.key === 'ArrowDown') { e.preventDefault(); idx = Math.min(idx+1, items.length-1); }
  else if (e.key === 'ArrowUp') { e.preventDefault(); idx = Math.max(idx-1, 0); }
  else if (e.key === 'Enter' && current) { e.preventDefault(); selectDropdownItem(key, current.dataset.val); return; }
  else if (e.key === 'Escape') { list.style.display='none'; return; }

  items.forEach(it => it.classList.remove('highlighted'));
  if (items[idx]) items[idx].classList.add('highlighted');
}

function closeAllDropdowns() {
  document.querySelectorAll('.dropdown-list').forEach(l => l.style.display='none');
  activeDropdown = null;
}

document.addEventListener('click', e => {
  if (!e.target.closest('.dropdown-wrap')) closeAllDropdowns();
});

// â”€â”€ FIELD UPDATES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function updateField(key, value) {
  parsedData[key] = value;
  if (key === 'category') {
    parsedData.group = CATEGORY_MAP[value] || '';
    const b = document.getElementById('badge-group');
    if (b) b.textContent = parsedData.group || 'â€”';
  }
}

function updateCharCount(inp) {
  const counter = document.getElementById('memo-count');
  if (!counter) return;
  const len = inp.value.length;
  counter.style.display = len > 0 ? 'block' : 'none';
  counter.textContent = `${len}/60`;
  counter.style.color = len > 50 ? 'var(--warn)' : 'var(--muted)';
}

// â”€â”€ LOG IT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function handleLogIt() {
  // Commit any open hero edits
  const amtInp = document.getElementById('r-amount-input');
  if (amtInp) commitAmount(amtInp.value);
  const mInp = document.getElementById('merchant-input');
  if (mInp) commitMerchant(mInp.value);
  const dInp = document.getElementById('date-input');
  if (dInp) commitDate(dInp.value);

  const d   = parsedData;
  const ts  = new Date().toISOString();
  const amt = d.type==='Income' ? Math.abs(d.amount) : -Math.abs(d.amount);
  const sheetDate = toSheetDate(d.date);
  const rows = [[ts, d.type, amt, sheetDate, d.merchant, d.paymentMethod, d.category, d.group, d.memo, d.review]];

  // Duplicate detection
  const dupeKey = `${d.amount}|${d.merchant}`;
  const now     = Date.now();
  if (dupeKey === lastLoggedKey && now - lastLoggedTime < 60000) {
    showDupeWarning(rows, d);
    return;
  }

  haptic('medium');
  appendRows(rows, d);
}

function showDupeWarning(rows, d) {
  const wrap = document.getElementById('dupe-warn-wrap');
  wrap.innerHTML = `
    <div class="dupe-card">
      <div class="dupe-title">âš  Possible duplicate</div>
      <div class="dupe-desc">Same amount and merchant logged less than a minute ago. Log again?</div>
      <div class="dupe-actions">
        <button class="btn-dupe-log" onclick="confirmDupe()">Log anyway</button>
        <button class="btn-dupe-cancel" onclick="dismissDupe()">Cancel</button>
      </div>
    </div>`;
  pendingRows = { rows, d };
}

function confirmDupe() {
  document.getElementById('dupe-warn-wrap').innerHTML = '';
  if (pendingRows) { haptic('medium'); appendRows(pendingRows.rows, pendingRows.d); pendingRows = null; }
}

function dismissDupe() {
  document.getElementById('dupe-warn-wrap').innerHTML = '';
  pendingRows = null;
}

// â”€â”€ MANUAL FORM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function buildManualForm(mode) {
  const today      = todayISO();
  const lastMethod = localStorage.getItem('lastPaymentMethod') || PAYMENT_METHODS[0];
  const c = document.getElementById('manual-form');

  const row = (key, ctrl) =>
    `<div class="form-row-inner"><div class="form-key">${key}</div>${ctrl}</div>`;

  const text = (id, ph, type='text') =>
    `<input class="form-ctrl" id="${id}" type="${type}" placeholder="${ph}">`;

  const selWith = (id, opts, selected, onch='') =>
    `<select class="form-select-ctrl" id="${id}" ${onch}>${opts.map(o=>`<option ${o===selected?'selected':''}>${o}</option>`).join('')}</select>`;

  const sel = (id, opts, onch='') => selWith(id, opts, opts[0], onch);

  if (mode === 'transfer') {
    c.innerHTML =
      row('Amount', `<input class="form-ctrl" id="m-amount" type="text" inputmode="decimal" placeholder="0.00" oninput="fmtAmt(this)">`) +
      row('Date',   `<input class="form-ctrl" id="m-date" type="date" value="${today}">`) +
      row('From',   selWith('m-from', PAYMENT_METHODS, lastMethod, 'onchange="syncTransferTo()"')) +
      row('To',     sel('m-to', PAYMENT_METHODS.filter(p=>p!==lastMethod))) +
      row('Memo',   text('m-memo','Optional'));
  } else {
    c.innerHTML =
      row('Type',     selWith('m-type',['Expense','Income'],'Expense','onchange="updateManualCats()"')) +
      row('Amount',   `<input class="form-ctrl" id="m-amount" type="text" inputmode="decimal" placeholder="0.00" oninput="fmtAmt(this)">`) +
      row('Date',     `<input class="form-ctrl" id="m-date" type="date" value="${today}">`) +
      row('Merchant', `<input class="form-ctrl" id="m-merchant" type="text" placeholder="Who or where" oninput="applyManualMerchantRules(this.value)">`) +
      row('Via',      selWith('m-payment', PAYMENT_METHODS, lastMethod)) +
      row('Category', `<select class="form-select-ctrl" id="m-category" onchange="updateManualGroup()">${EXPENSE_CATS.map(c=>`<option>${c}</option>`).join('')}</select>`) +
      row('Group',    `<input class="form-readonly" id="m-group" readonly value="${CATEGORY_MAP[EXPENSE_CATS[0]]||''}">`) +
      row('Memo',     text('m-memo','Optional')) +
      row('Review',   sel('m-review', REVIEW_OPTIONS));

    // Auto-focus amount
    setTimeout(() => document.getElementById('m-amount')?.focus(), 100);
  }
}

function fmtAmt(el) {
  const raw   = el.value.replace(/[^0-9.]/g,'');
  const parts = raw.split('.');
  const int   = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g,',');
  el.value    = parts.length > 1 ? `${int}.${parts[1].slice(0,2)}` : int;
}

function getRawAmt(id) {
  return parseFloat((document.getElementById(id)?.value||'0').replace(/,/g,''))||0;
}

function syncTransferTo() {
  const from = document.getElementById('m-from').value;
  const toSel = document.getElementById('m-to');
  if (!toSel) return;
  const filtered = PAYMENT_METHODS.filter(p => p !== from);
  toSel.innerHTML = filtered.map(p=>`<option>${p}</option>`).join('');
}

function applyManualMerchantRules(val) {
  const rules = applyMerchantRules(val);
  if (rules.paymentMethod) {
    const sel = document.getElementById('m-payment');
    if (sel) sel.value = rules.paymentMethod;
  }
  if (rules.category) {
    const sel = document.getElementById('m-category');
    if (sel) { sel.value = rules.category; updateManualGroup(); }
  }
}

function updateManualCats() {
  const type = document.getElementById('m-type').value;
  const cats  = type === 'Income' ? INCOME_CATS : EXPENSE_CATS;
  document.getElementById('m-category').innerHTML = cats.map(c=>`<option>${c}</option>`).join('');
  updateManualGroup();
}

function updateManualGroup() {
  const cat = document.getElementById('m-category')?.value;
  const el  = document.getElementById('m-group');
  if (el && cat) el.value = CATEGORY_MAP[cat] || '';
}

// â”€â”€ SUBMIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function submitManual() {
  const ts = new Date().toISOString();
  let rows = [], d = {};

  if (currentMode === 'transfer') {
    const amount = getRawAmt('m-amount');
    const date   = document.getElementById('m-date').value;
    const from   = document.getElementById('m-from').value;
    const to     = document.getElementById('m-to').value;
    const memo   = document.getElementById('m-memo').value;
    if (!amount || !date) { alert('Amount and date are required.'); return; }
    if (from === to) { alert('From and To accounts must be different.'); return; }
    const sd = toSheetDate(date);
    rows = [
      [ts,'Transfer',-amount, sd,`To ${to}`,   from,'','',memo,'Myself'],
      [ts,'Transfer', amount, sd,`From ${from}`,to,  '','',memo,'Myself'],
    ];
    d = { type:'Transfer', amount, category:'', paymentMethod:from };
    localStorage.setItem('lastPaymentMethod', from);
  } else {
    const type     = document.getElementById('m-type').value;
    const amount   = getRawAmt('m-amount');
    const date     = document.getElementById('m-date').value;
    const merchant = document.getElementById('m-merchant').value;
    const payment  = document.getElementById('m-payment').value;
    const category = document.getElementById('m-category').value;
    const memo     = document.getElementById('m-memo').value;
    const review   = document.getElementById('m-review').value;
    if (!amount || !date) { alert('Amount and date are required.'); return; }
    const amt   = type==='Income' ? Math.abs(amount) : -Math.abs(amount);
    const group = CATEGORY_MAP[category] || '';
    const sd    = toSheetDate(date);
    rows = [[ts, type, amt, sd, merchant, payment, category, group, memo, review]];
    d    = { type, amount, category, group, paymentMethod:payment, merchant };
    localStorage.setItem('lastPaymentMethod', payment);
  }

  haptic('medium');
  await appendRows(rows, d);
}

// â”€â”€ APPEND â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function appendRows(rows, d) {
  lastFailedRows = rows;

  try {
    const fd = new FormData();
    fd.append('data', JSON.stringify({ rows }));
    await fetch(WEBHOOK, { method: 'POST', body: fd });

    // Track for dupe detection
    if (d && d.amount && d.merchant) {
      lastLoggedKey  = `${d.amount}|${d.merchant}`;
      lastLoggedTime = Date.now();
    }

    lastFailedRows = null;

    // Success display
    document.getElementById('success-label').textContent =
      rows.length > 1 ? 'Transfer logged' : `${d?.type || 'Transaction'} logged`;

    const det = document.getElementById('success-detail');
    if (d && rows.length === 1) {
      det.innerHTML = `
        <div class="success-row">${fmt(Math.abs(rows[0][2]))}</div>
        <div class="success-row"><strong>${d.merchant || d.type}</strong> Â· ${d.paymentMethod}</div>
        ${d.category ? `<div class="success-row">${d.category} <span style="color:var(--muted)">â†’</span> ${d.group||''}</div>` : ''}`;
    } else if (rows.length > 1) {
      det.innerHTML = `<div class="success-row">${fmt(Math.abs(rows[0][2]))} moved</div>`;
    }

    show('screen-success');
    haptic('success');
    setTimeout(cancelConfirm, 2400);

  } catch(err) {
    console.error(err);
    haptic('error');
    show('screen-failure');
  }
}

function retryLog()  { if (lastFailedRows) appendRows(lastFailedRows, parsedData); }
function copyFailed() {
  if (!lastFailedRows) return;
  navigator.clipboard.writeText(lastFailedRows.map(r=>r.join('\t')).join('\n'))
    .then(() => alert('Row copied to clipboard.'));
}

// â”€â”€ BOOT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

loadSettings();
// Restore last mode
selectMode(currentMode);
</script>
</body>
</html>
