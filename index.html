<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>YNAB</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700&family=DM+Mono:wght@400;500&family=DM+Sans:wght@300;400;500&display=swap');

:root {
  --bg: #0b0b0d;
  --surface: #141416;
  --surface2: #1e1e22;
  --surface3: #28282e;
  --border: #2a2a30;
  --border2: #363640;
  --accent: #c8f564;
  --accent-dim: rgba(200,245,100,0.08);
  --accent-border: rgba(200,245,100,0.25);
  --text: #ededf0;
  --text2: #9898a6;
  --muted: #60606e;
  --danger: #ff5c5c;
  --danger-dim: rgba(255,92,92,0.08);
  --danger-border: rgba(255,92,92,0.25);
  --income: #c8f564;
  --expense: #ff5c5c;
  --transfer: #9b8fff;
  --transfer-dim: rgba(155,143,255,0.08);
}

* { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
html, body { height: 100%; }
body { font-family: 'DM Sans', sans-serif; background: var(--bg); color: var(--text); display: flex; justify-content: center; }

.app { width: 100%; max-width: 430px; min-height: 100%; display: flex; flex-direction: column; padding-bottom: 32px; }

/* TOP BAR */
.topbar { padding: 20px 20px 0; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
.wordmark { font-family: 'Syne', sans-serif; font-size: 18px; font-weight: 700; color: var(--text); letter-spacing: -0.02em; }
.wordmark span { color: var(--accent); }
.gear-btn { width: 36px; height: 36px; border-radius: 10px; border: 1px solid var(--border); background: var(--surface); color: var(--muted); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.15s; font-size: 16px; }
.gear-btn:hover { border-color: var(--border2); color: var(--text2); }

/* MODE PILLS */
.mode-strip { padding: 16px 20px 0; flex-shrink: 0; }
.pills { display: flex; background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 3px; gap: 2px; }
.pill { flex: 1; padding: 8px 4px; border-radius: 9px; font-size: 12px; font-weight: 500; color: var(--muted); text-align: center; cursor: pointer; transition: all 0.15s; white-space: nowrap; user-select: none; }
.pill:hover { color: var(--text2); }
.pill.active { background: var(--surface3); color: var(--text); font-weight: 600; }
.pill.active[data-mode="expense"] { color: var(--expense); }
.pill.active[data-mode="income"]  { color: var(--income); }
.pill.active[data-mode="transfer"]{ color: var(--transfer); }

/* CONTENT */
.content { flex: 1; padding: 16px 20px 0; display: flex; flex-direction: column; gap: 12px; }

/* SCREENS */
.screen { display: none; flex-direction: column; gap: 12px; }
.screen.active { display: flex; animation: fadeUp 0.18s ease; }
@keyframes fadeUp { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: translateY(0); } }

/* UPLOAD HERO */
.upload-hero { flex: 1; min-height: 260px; background: var(--surface); border: 1.5px dashed var(--border2); border-radius: 20px; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 14px; cursor: pointer; transition: all 0.2s ease; position: relative; overflow: hidden; }
.upload-hero::before { content: ''; position: absolute; inset: 0; background: radial-gradient(ellipse at 50% 0%, rgba(200,245,100,0.04) 0%, transparent 70%); pointer-events: none; }
.upload-hero:hover, .upload-hero.drag { border-color: var(--accent); background: var(--accent-dim); }
.upload-hero:active { transform: scale(0.99); }
.upload-icon { width: 60px; height: 60px; border-radius: 16px; background: var(--surface2); border: 1px solid var(--border2); display: flex; align-items: center; justify-content: center; font-size: 26px; }
.upload-label { font-family: 'Syne', sans-serif; font-size: 17px; font-weight: 600; color: var(--text); }
.upload-sub { font-size: 13px; color: var(--muted); }
#file-input { display: none; }

/* PARSING */
.parsing-screen { flex: 1; min-height: 260px; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 16px; background: var(--surface); border: 1px solid var(--border); border-radius: 20px; }
.pulse-ring { width: 48px; height: 48px; position: relative; display: flex; align-items: center; justify-content: center; }
.pulse-ring::before, .pulse-ring::after { content: ''; position: absolute; border: 1.5px solid var(--accent); border-radius: 50%; animation: pulse-out 1.4s ease-out infinite; }
.pulse-ring::after { animation-delay: 0.5s; }
@keyframes pulse-out { 0% { width: 16px; height: 16px; opacity: 0.8; } 100% { width: 48px; height: 48px; opacity: 0; } }
.pulse-dot { width: 10px; height: 10px; border-radius: 50%; background: var(--accent); z-index: 1; }
.parsing-text { font-size: 14px; color: var(--text2); }

/* RECEIPT CARD */
.receipt { background: var(--surface); border: 1px solid var(--border); border-radius: 20px; overflow: hidden; }
.receipt-hero { padding: 24px 22px 20px; border-bottom: 1px dashed var(--border2); position: relative; }
.receipt-amount { font-family: 'Syne', sans-serif; font-size: 38px; font-weight: 700; letter-spacing: -0.02em; line-height: 1; margin-bottom: 10px; }
.receipt-amount.expense  { color: var(--expense); }
.receipt-amount.income   { color: var(--income); }
.receipt-amount.transfer { color: var(--transfer); }
.receipt-meta { display: flex; align-items: center; gap: 8px; }
.receipt-merchant { font-size: 15px; font-weight: 500; color: var(--text); flex: 1; }
.receipt-date { font-family: 'DM Mono', monospace; font-size: 12px; color: var(--muted); }

/* FIELD ROWS */
.field-section { padding: 4px 0; }
.field-row { display: grid; grid-template-columns: 80px 1fr; align-items: center; padding: 10px 22px; border-bottom: 1px solid var(--border); min-height: 44px; transition: background 0.1s; }
.field-row:last-child { border-bottom: none; }
.field-row.editable { cursor: pointer; }
.field-row.editable:hover { background: var(--surface2); }
.field-row.focused { background: var(--accent-dim); }
.field-key { font-family: 'DM Mono', monospace; font-size: 10px; letter-spacing: 0.08em; text-transform: uppercase; color: var(--muted); }
.field-val { font-size: 14px; font-weight: 500; color: var(--text); text-align: right; }
.field-val.group-tag { display: flex; justify-content: flex-end; }
.group-badge { font-family: 'DM Mono', monospace; font-size: 10px; background: var(--surface3); border: 1px solid var(--border2); border-radius: 6px; padding: 2px 8px; color: var(--text2); letter-spacing: 0.04em; }
.inline-input { background: transparent; border: none; outline: none; font-family: 'DM Sans', sans-serif; font-size: 14px; font-weight: 500; color: var(--text); text-align: right; width: 100%; }
.inline-select { background: var(--surface2); border: 1px solid var(--border2); border-radius: 8px; color: var(--text); font-family: 'DM Sans', sans-serif; font-size: 13px; padding: 6px 10px; width: 100%; outline: none; text-align: right; }

/* TRANSFER NOTICE */
.transfer-notice { background: var(--transfer-dim); border: 1px solid rgba(155,143,255,0.2); border-radius: 12px; padding: 10px 14px; font-size: 12px; color: var(--transfer); display: flex; align-items: center; gap: 8px; }

/* ACTIONS */
.action-bar { display: flex; gap: 10px; }
.btn { flex: 1; padding: 16px; border-radius: 14px; font-family: 'Syne', sans-serif; font-size: 15px; font-weight: 600; border: none; cursor: pointer; transition: all 0.15s; letter-spacing: -0.01em; }
.btn:active { transform: scale(0.97); }
.btn-log { background: var(--accent); color: #0b0b0d; }
.btn-log:hover { background: #d4ff6e; }
.btn-ghost { background: var(--surface); border: 1px solid var(--border); color: var(--text2); }
.btn-ghost:hover { border-color: var(--border2); color: var(--text); }

/* FAILURE CARD */
.failure-card { background: var(--danger-dim); border: 1px solid var(--danger-border); border-radius: 16px; padding: 20px; display: flex; flex-direction: column; gap: 12px; }
.failure-title { font-family: 'Syne', sans-serif; font-size: 15px; font-weight: 600; color: var(--danger); }
.failure-desc { font-size: 13px; color: var(--text2); line-height: 1.5; }
.failure-actions { display: flex; gap: 8px; }
.btn-retry { flex: 1; padding: 12px; border-radius: 10px; background: var(--danger); color: #fff; font-family: 'Syne', sans-serif; font-size: 14px; font-weight: 600; border: none; cursor: pointer; transition: all 0.15s; }
.btn-copy  { flex: 1; padding: 12px; border-radius: 10px; background: var(--surface2); border: 1px solid var(--border2); color: var(--text2); font-family: 'Syne', sans-serif; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.15s; }

/* SUCCESS CARD */
.success-card { background: var(--accent-dim); border: 1px solid var(--accent-border); border-radius: 16px; padding: 28px 20px; display: flex; flex-direction: column; align-items: center; gap: 10px; text-align: center; }
.success-check { width: 44px; height: 44px; border-radius: 50%; background: var(--accent); display: flex; align-items: center; justify-content: center; font-size: 20px; color: #0b0b0d; }
.success-label { font-family: 'Syne', sans-serif; font-size: 16px; font-weight: 600; color: var(--accent); }
.success-sub { font-size: 13px; color: var(--text2); }

/* MANUAL FORM */
.form-block { background: var(--surface); border: 1px solid var(--border); border-radius: 16px; overflow: hidden; }
.form-row-inner { display: grid; grid-template-columns: 80px 1fr; align-items: center; padding: 12px 18px; border-bottom: 1px solid var(--border); min-height: 48px; }
.form-row-inner:last-child { border-bottom: none; }
.form-key { font-family: 'DM Mono', monospace; font-size: 10px; letter-spacing: 0.08em; text-transform: uppercase; color: var(--muted); }
.form-ctrl { background: transparent; border: none; outline: none; font-family: 'DM Sans', sans-serif; font-size: 14px; font-weight: 500; color: var(--text); text-align: right; width: 100%; }
.form-ctrl::placeholder { color: var(--muted); }
.form-select-ctrl { background: transparent; border: none; outline: none; font-family: 'DM Sans', sans-serif; font-size: 14px; color: var(--text); text-align: right; width: 100%; cursor: pointer; }

/* SETTINGS */
.overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.75); backdrop-filter: blur(6px); z-index: 100; display: none; align-items: flex-end; justify-content: center; }
.overlay.open { display: flex; }
.sheet { width: 100%; max-width: 430px; background: var(--surface); border-radius: 24px 24px 0 0; border: 1px solid var(--border); border-bottom: none; padding: 12px 20px 48px; display: flex; flex-direction: column; gap: 14px; animation: slideUp 0.22s ease; }
@keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
.sheet-handle { width: 36px; height: 4px; background: var(--border2); border-radius: 2px; margin: 0 auto 4px; }
.sheet-title { font-family: 'Syne', sans-serif; font-size: 17px; font-weight: 700; }
.setting-group { display: flex; flex-direction: column; gap: 6px; }
.setting-label { font-family: 'DM Mono', monospace; font-size: 10px; color: var(--muted); letter-spacing: 0.1em; text-transform: uppercase; }
.setting-input { background: var(--surface2); border: 1px solid var(--border); border-radius: 10px; color: var(--text); font-family: 'DM Mono', monospace; font-size: 13px; padding: 12px 14px; outline: none; transition: border-color 0.15s; width: 100%; }
.setting-input:focus { border-color: var(--accent-border); }
.setting-hint { font-size: 11px; color: var(--muted); line-height: 1.6; }
</style>
</head>
<body>
<div class="app">
  <div class="topbar">
    <div class="wordmark">YNA<span>B</span></div>
    <div class="gear-btn" onclick="openSettings()">âš™</div>
  </div>

  <div class="mode-strip">
    <div class="pills">
      <div class="pill active" data-mode="expense"  onclick="selectMode('expense')">Expense</div>
      <div class="pill"        data-mode="income"   onclick="selectMode('income')">Income</div>
      <div class="pill"        data-mode="transfer" onclick="selectMode('transfer')">Transfer</div>
      <div class="pill"        data-mode="manual"   onclick="selectMode('manual')">Manual</div>
    </div>
  </div>

  <div class="content">

    <!-- UPLOAD -->
    <div class="screen active" id="screen-upload">
      <div class="upload-hero" id="upload-hero" onclick="document.getElementById('file-input').click()">
        <div class="upload-icon" id="upload-icon">ðŸ“·</div>
        <div class="upload-label" id="upload-label">Share a screenshot</div>
        <div class="upload-sub" id="upload-sub">GCash, credit card, any bank app</div>
      </div>
      <input type="file" id="file-input" accept="image/*" onchange="handleFile(event)">
    </div>

    <!-- PARSING -->
    <div class="screen" id="screen-parsing">
      <div class="parsing-screen">
        <div class="pulse-ring"><div class="pulse-dot"></div></div>
        <div class="parsing-text">Reading screenshotâ€¦</div>
      </div>
    </div>

    <!-- CONFIRM -->
    <div class="screen" id="screen-confirm">
      <div class="receipt">
        <div class="receipt-hero">
          <div class="receipt-amount" id="r-amount">â‚±0.00</div>
          <div class="receipt-meta">
            <div class="receipt-merchant" id="r-merchant">â€”</div>
            <div class="receipt-date" id="r-date">â€”</div>
          </div>
        </div>
        <div class="field-section" id="r-fields"></div>
      </div>
      <div id="transfer-notice" class="transfer-notice" style="display:none">â†• Logs 2 rows â€” outgoing and incoming.</div>
      <div class="action-bar">
        <div class="btn btn-ghost" onclick="cancelConfirm()">Retake</div>
        <div class="btn btn-log"   onclick="logTransaction()">Log It</div>
      </div>
    </div>

    <!-- FAILURE -->
    <div class="screen" id="screen-failure">
      <div class="failure-card">
        <div class="failure-title">Failed to log</div>
        <div class="failure-desc">Transaction didn't reach your Sheet. Your data is safe â€” retry or copy it to paste manually.</div>
        <div class="failure-actions">
          <button class="btn-retry" onclick="retryLog()">Retry</button>
          <button class="btn-copy"  onclick="copyFailed()">Copy row</button>
        </div>
      </div>
      <div class="btn btn-ghost" onclick="cancelConfirm()">Start over</div>
    </div>

    <!-- SUCCESS -->
    <div class="screen" id="screen-success">
      <div class="success-card">
        <div class="success-check">âœ“</div>
        <div class="success-label" id="success-label">Logged</div>
        <div class="success-sub"   id="success-sub"></div>
      </div>
    </div>

    <!-- MANUAL -->
    <div class="screen" id="screen-manual">
      <div class="form-block" id="manual-form"></div>
      <div class="action-bar">
        <div class="btn btn-ghost" onclick="cancelConfirm()">Cancel</div>
        <div class="btn btn-log"   onclick="submitManual()">Log It</div>
      </div>
    </div>

  </div>
</div>

<!-- SETTINGS SHEET -->
<div class="overlay" id="overlay" onclick="closeSettings(event)">
  <div class="sheet">
    <div class="sheet-handle"></div>
    <div class="sheet-title">Settings</div>
    <div class="setting-group">
      <div class="setting-label">Gemini API Key</div>
      <input class="setting-input" type="password" id="s-gemini" placeholder="AIzaâ€¦" oninput="saveSetting('gemini',this.value)">
    </div>
    <div class="setting-group">
      <div class="setting-label">Google Sheet ID</div>
      <input class="setting-input" type="text" id="s-sheetid" placeholder="Sheet ID from URL" oninput="saveSetting('sheetId',this.value)">
    </div>
    <div class="setting-group">
      <div class="setting-label">Google API Key</div>
      <input class="setting-input" type="password" id="s-googleapi" placeholder="AIzaâ€¦" oninput="saveSetting('googleApi',this.value)">
      <div class="setting-hint">Needs Sheets API enabled. Free at console.cloud.google.com.</div>
    </div>
    <div class="btn btn-log" onclick="closeSettings()">Done</div>
  </div>
</div>

<script>
const SHEET_TAB = 'Log';

const CATEGORY_MAP = {
  'Salary':'Income','IOU':'Income',
  'Electricity':'Home','Groceries':'Home','Lulay':'Home',
  'Pet Food':'Pets','Grooming':'Pets','Litter':'Pets','Misc':'Pets','Vet':'Pets',
  'Doctor':'Health','Supplements':'Health','Therapy':'Health','Medicine':'Health','Lab Tests':'Health','Eyes':'Health',
  'Cellphone':'Quality Of Life','Eating Out':'Quality Of Life','Car':'Quality Of Life','Self Care':'Quality Of Life',
  'Social':'Quality Of Life','Shopping':'Quality Of Life','Transpo':'Quality Of Life','Others':'Quality Of Life',
  'Stellar Rebels':'Stellar Rebels',
  'Digital Subscriptions':'Sinking','Gifts':'Sinking','Car Maintenance':'Sinking','Home Maintenance':'Sinking',
  'Family Emergency':'Emergency','Medical Emergency':'Emergency','Pet Emergency':'Emergency','Job Loss':'Emergency',
  'Tech Fund':'Goals','Beauty Fund':'Goals','Vacation Fund':'Goals',
};

const INCOME_CATS     = ['Salary','IOU'];
const EXPENSE_CATS    = Object.keys(CATEGORY_MAP).filter(c => !INCOME_CATS.includes(c));
const PAYMENT_METHODS = ['GCash','Credit Card','Maribank','BDO','BPI','Maya','UnionBank','UnionBank Credit','Cash'];
const REVIEW_OPTIONS  = ['Myself','Others','Both','Other'];

let currentMode    = 'expense';
let parsedData     = {};
let lastFailedRows = null;

localStorage.setItem('gemini',    'AIzaSyCEYTXVwfZBN6oa57sdOAmT-qjHhe9ZHAI');
localStorage.setItem('sheetId',   '1drs7PNpxLeatQKMI5pT1zS9Ug6JsGtpWAiBUCjoKHME');
localStorage.setItem('googleApi', 'AIzaSyAIWrvjahe4igTASSbYipu8hUU_fHTOazM');

function loadSettings() {
  document.getElementById('s-gemini').value    = localStorage.getItem('gemini')    || '';
  document.getElementById('s-sheetid').value   = localStorage.getItem('sheetId')   || '';
  document.getElementById('s-googleapi').value = localStorage.getItem('googleApi') || '';
}
function saveSetting(k,v) { localStorage.setItem(k,v); }
function openSettings()   { loadSettings(); document.getElementById('overlay').classList.add('open'); }
function closeSettings(e) { if (!e || e.target===document.getElementById('overlay')) document.getElementById('overlay').classList.remove('open'); }

function show(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

function cancelConfirm() {
  parsedData = {}; lastFailedRows = null;
  refreshHero();
  show('screen-upload');
}

function selectMode(mode) {
  currentMode = mode;
  document.querySelectorAll('.pill').forEach(p => p.classList.toggle('active', p.dataset.mode === mode));
  if (mode === 'transfer' || mode === 'manual') { buildManualForm(mode); show('screen-manual'); }
  else { refreshHero(); show('screen-upload'); }
}

function refreshHero() {
  const map = {
    expense: { icon:'ðŸ“·', label:'Share a screenshot',  sub:'GCash, credit card, any bank app' },
    income:  { icon:'ðŸ“¥', label:'Share a screenshot',  sub:'Salary slip, GCash, any inflow' },
  };
  const d = map[currentMode] || map.expense;
  document.getElementById('upload-icon').textContent  = d.icon;
  document.getElementById('upload-label').textContent = d.label;
  document.getElementById('upload-sub').textContent   = d.sub;
}

function handleFile(e) {
  const file = e.target.files[0]; if (!file) return;
  e.target.value = '';
  const reader = new FileReader();
  reader.onload = () => parseWithGemini(reader.result);
  reader.readAsDataURL(file);
}

async function parseWithGemini(dataUrl) {
  const apiKey = localStorage.getItem('gemini');
  if (!apiKey) { alert('Add your Gemini API key in Settings first.'); return; }
  show('screen-parsing');

  const cats  = currentMode === 'income' ? INCOME_CATS.join(', ') : EXPENSE_CATS.join(', ');
  const today = new Date().toISOString().split('T')[0];
  const prompt = `Extract transaction data from this Filipino payment app screenshot.
Return ONLY valid JSON â€” no markdown, no explanation:
{"amount":number,"date":"YYYY-MM-DD","merchant":"string","payment_method":"one of: GCash, Credit Card, Maribank, BDO, BPI, Maya, UnionBank, UnionBank Credit, Cash","category":"one of: ${cats}"}
Rules: amount always positive. Default payment_method to GCash if unclear. Pick closest category from the list. If date unclear use ${today}.`;

  const base64   = dataUrl.split(',')[1];
  const mimeType = dataUrl.split(';')[0].split(':')[1];

  try {
    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`,{
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ contents:[{parts:[{text:prompt},{inline_data:{mime_type:mimeType,data:base64}}]}], generationConfig:{maxOutputTokens:300,temperature:0.1} })
    });
    const data   = await res.json();
    const raw    = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
    const parsed = JSON.parse(raw.replace(/```json|```/g,'').trim());

    parsedData = {
      type: currentMode === 'income' ? 'Income' : 'Expense',
      amount: parsed.amount, date: parsed.date, merchant: parsed.merchant,
      paymentMethod: parsed.payment_method, category: parsed.category,
      group: CATEGORY_MAP[parsed.category] || '', memo: '', review: 'Myself',
    };
    buildReceiptCard();
    show('screen-confirm');
  } catch(err) {
    console.error(err);
    alert('Could not parse screenshot. Try again or use Manual.');
    show('screen-upload');
  }
}

function buildReceiptCard() {
  const d = parsedData;
  const amtEl = document.getElementById('r-amount');
  amtEl.textContent = `â‚±${Number(d.amount).toLocaleString('en-PH',{minimumFractionDigits:2,maximumFractionDigits:2})}`;
  amtEl.className   = `receipt-amount ${d.type.toLowerCase()}`;
  document.getElementById('r-merchant').textContent = d.merchant || 'â€”';
  document.getElementById('r-date').textContent     = d.date     || 'â€”';
  document.getElementById('transfer-notice').style.display = 'none';

  const cats   = d.type === 'Income' ? INCOME_CATS : EXPENSE_CATS;
  const fields = [
    { key:'Via',      dataKey:'paymentMethod', type:'select', options:PAYMENT_METHODS },
    { key:'Category', dataKey:'category',      type:'select', options:cats },
    { key:'Group',    dataKey:'group',          type:'badge' },
    { key:'Memo',     dataKey:'memo',           type:'text' },
    { key:'Review',   dataKey:'review',         type:'select', options:REVIEW_OPTIONS },
  ];

  const container = document.getElementById('r-fields');
  container.innerHTML = '';
  fields.forEach(f => {
    const row = document.createElement('div');
    row.className   = `field-row ${f.type !== 'badge' ? 'editable' : ''}`;
    row.dataset.key = f.dataKey;

    if (f.type === 'badge') {
      row.innerHTML = `<div class="field-key">${f.key}</div><div class="field-val group-tag"><span class="group-badge" id="badge-group">${d[f.dataKey]||'â€”'}</span></div>`;
    } else if (f.type === 'text') {
      row.innerHTML = `<div class="field-key">${f.key}</div><input class="inline-input" value="${d[f.dataKey]||''}" placeholder="Optional" onfocus="this.closest('.field-row').classList.add('focused')" onblur="this.closest('.field-row').classList.remove('focused');updateField('${f.dataKey}',this.value)">`;
    } else {
      const opts = f.options.map(o=>`<option ${d[f.dataKey]===o?'selected':''}>${o}</option>`).join('');
      row.innerHTML = `<div class="field-key">${f.key}</div><select class="inline-select" onchange="updateField('${f.dataKey}',this.value)">${opts}</select>`;
    }
    container.appendChild(row);
  });
}

function updateField(key, value) {
  parsedData[key] = value;
  if (key === 'category') { parsedData.group = CATEGORY_MAP[value]||''; const b = document.getElementById('badge-group'); if(b) b.textContent = parsedData.group||'â€”'; }
  if (key === 'merchant')  document.getElementById('r-merchant').textContent = value||'â€”';
  if (key === 'date')      document.getElementById('r-date').textContent     = value||'â€”';
  if (key === 'amount')    document.getElementById('r-amount').textContent   = `â‚±${Number(value).toLocaleString('en-PH',{minimumFractionDigits:2,maximumFractionDigits:2})}`;
}

function buildManualForm(mode) {
  const today = new Date().toISOString().split('T')[0];
  const c = document.getElementById('manual-form');
  const row  = (key, ctrl) => `<div class="form-row-inner"><div class="form-key">${key}</div>${ctrl}</div>`;
  const text = (id,ph,type='text') => `<input class="form-ctrl" id="${id}" type="${type}" placeholder="${ph}">`;
  const sel  = (id,opts,onch='') => `<select class="form-select-ctrl" id="${id}" ${onch}>${opts.map(o=>`<option>${o}</option>`).join('')}</select>`;

  const amountInput = (id) => `<input class="form-ctrl" id="${id}" type="text" inputmode="decimal" placeholder="0.00" oninput="formatAmountInput(this)">`;

  if (mode === 'transfer') {
    c.innerHTML =
      row('Amount', amountInput('m-amount')) +
      row('Date',   `<input class="form-ctrl" id="m-date" type="date" value="${today}">`) +
      row('From',   sel('m-from', PAYMENT_METHODS)) +
      row('To',     sel('m-to',   PAYMENT_METHODS)) +
      row('Memo',   text('m-memo','Optional'));
  } else {
    c.innerHTML =
      row('Type',     sel('m-type',['Expense','Income'],'onchange="updateManualCats()"')) +
      row('Amount',   amountInput('m-amount')) +
      row('Date',     `<input class="form-ctrl" id="m-date" type="date" value="${today}">`) +
      row('Merchant', text('m-merchant','Who or where')) +
      row('Via',      sel('m-payment', PAYMENT_METHODS)) +
      row('Category', sel('m-category', EXPENSE_CATS,'onchange="updateManualGroup()"')) +
      row('Group',    `<input class="form-ctrl" id="m-group" readonly style="color:var(--muted);cursor:default" value="${CATEGORY_MAP[EXPENSE_CATS[0]]||''}">`) +
      row('Memo',     text('m-memo','Optional')) +
      row('Review',   sel('m-review', REVIEW_OPTIONS));
  }
}

function formatAmountInput(el) {
  const raw = el.value.replace(/[^0-9.]/g, '');
  const parts = raw.split('.');
  const int = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ',');
  el.value = parts.length > 1 ? `${int}.${parts[1].slice(0,2)}` : int;
}

function getRawAmount(id) {
  return parseFloat((document.getElementById(id)?.value || '0').replace(/,/g, '')) || 0;
}

function updateManualCats() {
  const type = document.getElementById('m-type').value;
  document.getElementById('m-category').innerHTML = (type==='Income'?INCOME_CATS:EXPENSE_CATS).map(c=>`<option>${c}</option>`).join('');
  updateManualGroup();
}

function updateManualGroup() {
  const cat = document.getElementById('m-category')?.value;
  const el  = document.getElementById('m-group');
  if (el && cat) el.value = CATEGORY_MAP[cat]||'';
}

async function logTransaction() {
  const d   = parsedData;
  const ts  = new Date().toISOString();
  const amt = d.type==='Income' ? Math.abs(d.amount) : -Math.abs(d.amount);
  await appendRows([[ts, d.type, amt, d.date, d.merchant, d.paymentMethod, d.category, d.group, d.memo, d.review]]);
}

async function submitManual() {
  const ts = new Date().toISOString(); let rows = [];
  if (currentMode === 'transfer') {
    const amount = getRawAmount('m-amount');
    const date   = document.getElementById('m-date').value;
    const from   = document.getElementById('m-from').value;
    const to     = document.getElementById('m-to').value;
    const memo   = document.getElementById('m-memo').value;
    if (!amount||!date) { alert('Amount and date are required.'); return; }
    rows = [[ts,'Transfer',-amount,date,`To ${to}`,from,'','',memo,'Myself'],[ts,'Transfer',amount,date,`From ${from}`,to,'','',memo,'Myself']];
    parsedData = { type:'Transfer', amount, category:'', paymentMethod:from };
  } else {
    const type     = document.getElementById('m-type').value;
    const amount   = getRawAmount('m-amount');
    const date     = document.getElementById('m-date').value;
    const merchant = document.getElementById('m-merchant').value;
    const payment  = document.getElementById('m-payment').value;
    const category = document.getElementById('m-category').value;
    const memo     = document.getElementById('m-memo').value;
    const review   = document.getElementById('m-review').value;
    if (!amount||!date) { alert('Amount and date are required.'); return; }
    const amt = type==='Income' ? Math.abs(amount) : -Math.abs(amount);
    const group = CATEGORY_MAP[category] || '';
    rows = [[ts,type,amt,date,merchant,payment,category,group,memo,review]];
    parsedData = { type, amount, category, paymentMethod:payment };
  }
  await appendRows(rows);
}

async function appendRows(rows) {
  lastFailedRows = rows;
  const WEBHOOK = 'https://script.google.com/macros/s/AKfycbxnO4E8i-a34Qyark9t98Bcr0cxkdMugtqNDH1SLOxmwgnQbecad2VAsRuS4VOUvuIr_Q/exec';

  try {
    const res = await fetch(WEBHOOK, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain' },
      body: JSON.stringify({ rows })
    });

    lastFailedRows = null;
    const d   = parsedData;
    const sub = rows.length > 1
      ? `${rows.length} rows logged`
      : `${d.category||d.type} Â· â‚±${Math.abs(rows[0][2]).toLocaleString('en-PH',{minimumFractionDigits:2,maximumFractionDigits:2})} Â· ${d.paymentMethod}`;
    document.getElementById('success-label').textContent = rows.length > 1 ? 'Transfer logged' : 'Logged';
    document.getElementById('success-sub').textContent   = sub;
    show('screen-success');
    setTimeout(cancelConfirm, 2200);
  } catch(err) {
    console.error(err);
    show('screen-failure');
  }
}

function retryLog()  { if (lastFailedRows) appendRows(lastFailedRows); }
function copyFailed() {
  if (!lastFailedRows) return;
  navigator.clipboard.writeText(lastFailedRows.map(r=>r.join('\t')).join('\n'))
    .then(()=>alert('Row copied to clipboard.'));
}

loadSettings();
</script>
</body>
</html>
